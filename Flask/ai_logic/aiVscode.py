from transformers import AutoTokenizer, AutoModelForSequenceClassification
import torch
import os

# 경로 설정 및 모델 로딩
checkpoint_dir_6 = "D:\kosmo154\_project\emotionAI\csv_model"
if not os.path.isdir(checkpoint_dir_6):
    raise ValueError(f"경로가 존재하지 않습니다: {checkpoint_dir_6}")

tokenizer_6 = AutoTokenizer.from_pretrained(checkpoint_dir_6, local_files_only=True)
model_6 = AutoModelForSequenceClassification.from_pretrained(checkpoint_dir_6, local_files_only=True)
model_6.eval()

model_name_60 = "hun3359/klue-bert-base-sentiment"
tokenizer_60 = AutoTokenizer.from_pretrained(model_name_60)
model_60 = AutoModelForSequenceClassification.from_pretrained(model_name_60)
model_60.eval()

# 디바이스 설정
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model_6.to(device)
model_60.to(device)

label2emotion_6 = {
    0: "분노", 1: "슬픔", 2: "불안", 3: "상처", 4: "당황", 5: "기쁨"
}

label2emotion_60 = {
    0: "분노",
    1: "툴툴대는",
    2: "좌절한",
    3: "짜증내는",
    4: "방어적인",
    5: "악의적인",
    6: "안달하는",
    7: "구역질 나는",
    8: "노여워하는",
    9: "성가신",
    10: "슬픔",
    11: "실망한",
    12: "비통한",
    13: "후회되는",
    14: "우울한",
    15: "마비된",
    16: "염세적인",
    17: "눈물이 나는",
    18: "낙담한",
    19: "환멸을 느끼는",
    20: "불안",
    21: "두려운",
    22: "스트레스 받는",
    23: "취약한",
    24: "혼란스러운",
    25: "당혹스러운",
    26: "회의적인",
    27: "걱정스러운",
    28: "조심스러운",
    29: "초조한",
    30: "상처",
    31: "질투하는",
    32: "배신당한",
    33: "고립된",
    34: "충격 받은",
    35: "가난한 불우한",
    36: "희생된",
    37: "억울한",
    38: "괴로워하는",
    39: "버려진",
    40: "당황",
    41: "고립된(당황한)",
    42: "남의 시선을 의식하는",
    43: "외로운",
    44: "열등감",
    45: "죄책감의",
    46: "부끄러운",
    47: "혐오스러운",
    48: "한심한",
    49: "혼란스러운(당황한)",
    50: "기쁨",
    51: "감사하는",
    52: "신뢰하는",
    53: "편안한",
    54: "만족스러운",
    55: "흥분",
    56: "느긋",
    57: "안도",
    58: "신이 난",
    59: "자신하는"
}

custom_combinations = {
    ("신이 난", "흥분", "안도"): ["#들뜬하루", "#기대감"],
    ("신이 난", "안도", "흥분"): ["#긴장해소", "#안정속기쁨"],
    ("흥분", "신이 난", "안도"): ["#감정고조", "#에너지폭발"],
    ("불안", "슬픔", "걱정스러운"): ["#감정혼란", "#불편한하루"],
    ("불안", "걱정스러운", "슬픔"): ["#긴장과우울", "#복잡한마음"],
    ("슬픔", "불안", "우울한"): ["#마음의구름", "#침체된기분"],
    ("기쁨", "신이 난", "만족스러운"): ["#완벽한하루", "#행복충전"],
    ("기쁨", "감사하는", "편안한"): ["#소확행", "#잔잔한행복"],
    ("분노", "짜증내는", "성가신"): ["#화가난하루", "#짜증폭발"],
    ("분노", "억울한", "괴로워하는"): ["#억울함", "#감정폭발"],
    ("당황", "혼란스러운", "초조한"): ["#혼란의연속", "#불확실한기분"],
    ("상처", "배신당한", "외로운"): ["#외로움", "#신뢰붕괴"],
    ("불안", "초조한", "두려운"): ["#불안감", "#긴장된하루"],
    ("우울한", "눈물이 나는", "실망한"): ["#우울모드", "#마음이무거워"],
    ("자신하는", "신뢰하는", "기쁨"): ["#자신감업", "#믿음과희망"],
        ("성가신", "짜증내는", "툴툴대는"): ["#짜증주의보", "#불쾌지수상승"],
    ("감사하는", "기쁨", "편안한"): ["#따뜻한마음", "#행복의순간"],
    ("실망한", "우울한", "분노"): ["#감정기복", "#실망과분노"],
    ("눈물이 나는", "비통한", "낙담한"): ["#마음의폭우", "#슬픔이가득"],
    ("두려운", "스트레스 받는", "불안"): ["#불안장벽", "#긴장상태"],
    ("편안한", "느긋", "안도"): ["#휴식의시간", "#마음의여유"],
    ("가난한 불우한", "희생된", "억울한"): ["#부당한현실", "#불공정"],
    ("질투하는", "배신당한", "열등감"): ["#질투심폭발", "#자존감회복필요"],
    ("외로운", "고립된", "당황"): ["#사회적고립", "#어색한하루"],
     ("분노", "짜증내는", "불안"): ["#불쾌지수100", "#터지기직전"],
    ("슬픔", "후회되는", "눈물이 나는"): ["#지나간후회", "#눈물샘폭발"],
    ("불안", "취약한", "초조한"): ["#마음불안정", "#쉽지않은하루"],
    ("기쁨", "만족스러운", "자신하는"): ["#성취감", "#나를믿어"],
    ("당황", "혼란스러운(당황한)", "남의 시선을 의식하는"): ["#당황주의", "#시선의식"],
    ("우울한", "외로운", "열등감"): ["#혼자만의생각", "#자존감케어필요"],
    ("안도", "편안한", "느긋"): ["#마음의쉼표", "#여유로운시간"],
    ("신이 난", "자신하는", "흥분"): ["#전력질주", "#에너지풀가동"],
    ("스트레스 받는", "짜증내는", "회의적인"): ["#스트레스폭발", "#현타"],
    ("감사하는", "신뢰하는", "편안한"): ["#고마움", "#든든한존재"],
    ("괴로워하는", "비통한", "마비된"): ["#감정소진", "#지친마음"],
    ("기쁨", "흥분", "신이 난"): ["#신나는순간", "#행복에너지"],
    ("질투하는", "배신당한", "슬픔"): ["#복잡한감정", "#뒤통수맞은기분"],
    ("성가신", "방어적인", "짜증내는"): ["#방어모드", "#기분상했어요"],
    ("눈물이 나는", "실망한", "후회되는"): ["#감정의골짜기", "#눈물주의보"],
    ("신뢰하는", "자신하는", "편안한"): ["#마음의여유", "#믿음의힘"],
    ("초조한", "두려운", "불안"): ["#앞이깜깜", "#걱정가득"],
    ("괴로워하는", "고립된", "버려진"): ["#외로운싸움", "#혼자인기분"],
    ("감사하는", "기쁨", "만족스러운"): ["#감사일기", "#행복기록"],
    ("짜증내는", "성가신", "툴툴대는"): ["#오늘좀그래", "#건들지마요"],
    ("신뢰하는", "자신하는", "편안한"): ["#마음의여유", "#믿음의힘"],
    ("초조한", "두려운", "불안"): ["#앞이깜깜", "#걱정가득"],
    ("괴로워하는", "고립된", "버려진"): ["#외로운싸움", "#혼자인기분"],
    ("감사하는", "기쁨", "만족스러운"): ["#감사일기", "#행복기록"],
    ("짜증내는", "성가신", "툴툴대는"): ["#오늘좀그래", "#건들지마요"],
    ("외로운", "질투하는", "슬픔"): ["#관계고민", "#혼자인기분"],
    ("불안", "초조한", "두려운"): ["#긴장MAX", "#불안폭발"],
    ("신이 난", "흥분", "기쁨"): ["#하이텐션", "#오늘기분좋아"],
    ("우울한", "비통한", "눈물이 나는"): ["#눈물주의보", "#내마음구조신호"],
    ("기쁨", "편안한", "느긋"): ["#여유로운하루", "#소소한행복"],
    ("스트레스 받는", "짜증내는", "회의적인"): ["#현타온날", "#그냥다싫음"],
    ("분노", "악의적인", "성가신"): ["#폭발직전", "#화산주의보"],
    ("신이 난", "감사하는", "자신하는"): ["#오늘하루완벽", "#에너지뿜뿜"],
    ("당황", "혼란스러운", "취약한"): ["#멘붕주의보", "#나혼란스러움"],
    ("후회되는", "실망한", "상처"): ["#지난선택", "#마음에흠집"],
    ("감사하는", "편안한", "신뢰하는"): ["#따뜻한하루", "#믿음이주는안정감"],
    ("질투하는", "배신당한", "억울한"): ["#왜나만", "#믿은내가바보"],
    ("신이 난", "자신하는", "만족스러운"): ["#오늘컨디션최고", "#나를믿는다"],
    ("슬픔", "우울한", "외로운"): ["#회색하루", "#조용한울림"],
    ("안달하는", "초조한", "불안"): ["#조급한마음", "#기다림의불편함"],
    ("편안한", "만족스러운", "안도"): ["#오늘성공", "#마무리굿"],
    ("기쁨", "신이 난", "흥분"): ["#기분업", "#에너지넘침"],
      ("우울한", "초조한", "실망한"): ["#불안한내일", "#무기력한마음"],
  ("짜증내는", "성가신", "스트레스 받는"): ["#짜증폭발주의보", "#감정절정"],
  ("기쁨", "감사하는", "자신하는"): ["#긍정에너지", "#행복자신감"],
  ("불안", "혼란스러운", "당혹스러운"): ["#혼란한하루", "#감정회오리"],
  ("신이 난", "기쁨", "자신하는"): ["#오늘기분최고", "#자신감폭발"],
 ( "비통한", "슬픔", "눈물이 나는"): ["#마음의상처", "#슬픔의파도"],
 ( "편안한", "안도", "만족스러운"): ["#조용한행복", "#마음의평화"],
  ("고립된", "외로운", "낙담한"): ["#혼자인기분", "#마음의공허"],
  ("짜증내는", "툴툴대는", "성가신"): ["#짜증지수상승", "#괜히예민한날"],
  ("신이 난", "기쁨", "편안한"): ["#좋은기운", "#행복한순간"]
}

emotion_to_tags_map = {
    "분노": ["#분노", "#화남", "#분개"],
    "툴툴대는": ["#툴툴", "#불만"],
    "좌절한": ["#좌절", "#실망", "#포기"],
    "짜증내는": ["#짜증", "#불쾌"],
    "방어적인": ["#방어적", "#경계"],
    "악의적인": ["#악의", "#적대감"],
    "안달하는": ["#안달", "#초조"],
    "구역질 나는": ["#혐오", "#역겨움"],
    "노여워하는": ["#노여움", "#분노"],
    "성가신": ["#성가심", "#귀찮음"],
    "슬픔": ["#슬픔", "#우울", "#비탄"],
    "실망한": ["#실망", "#낙담"],
    "비통한": ["#비통", "#비애"],
    "후회되는": ["#후회", "#뉘우침"],
    "우울한": ["#우울", "#침울"],
    "마비된": ["#무기력", "#마비"],
    "염세적인": ["#염세", "#비관"],
    "눈물이 나는": ["#눈물", "#감정폭발"],
    "낙담한": ["#낙담", "#실망"],
    "환멸을 느끼는": ["#환멸", "#실망"],
    "불안": ["#불안", "#초조", "#걱정"],
    "두려운": ["#두려움", "#공포"],
    "스트레스 받는": ["#스트레스", "#압박감"],
    "취약한": ["#취약", "#불안정"],
    "혼란스러운": ["#혼란", "#당혹"],
    "당혹스러운": ["#당혹", "#혼란"],
    "회의적인": ["#회의", "#불신"],
    "걱정스러운": ["#걱정", "#불안"],
    "조심스러운": ["#조심", "#경계"],
    "초조한": ["#초조", "#불안"],
    "상처": ["#상처", "#아픔"],
    "질투하는": ["#질투", "#시기"],
    "배신당한": ["#배신감", "#상처"],
    "고립된": ["#고립", "#외로움"],
    "충격 받은": ["#충격", "#경악"],
    "가난한 불우한": ["#가난", "#불우"],
    "희생된": ["#희생", "#아픔"],
    "억울한": ["#억울함", "#분함"],
    "괴로워하는": ["#괴로움", "#고통"],
    "버려진": ["#버림", "#외로움"],
    "당황": ["#당황", "#혼란"],
    "고립된(당황한)": ["#고립", "#당황"],
    "남의 시선을 의식하는": ["#남의시선", "#불안"],
    "외로운": ["#외로움", "#고독"],
    "열등감": ["#열등감", "#자존감하락"],
    "죄책감의": ["#죄책감", "#후회"],
    "부끄러운": ["#부끄러움", "#수치심"],
    "혐오스러운": ["#혐오", "#역겨움"],
    "한심한": ["#한심", "#자책"],
    "혼란스러운(당황한)": ["#혼란", "#당황"],
    "기쁨": ["#기쁨", "#행복", "#즐거움"],
    "감사하는": ["#감사", "#고마움"],
    "신뢰하는": ["#신뢰", "#믿음"],
    "편안한": ["#편안함", "#안정"],
    "만족스러운": ["#만족", "#기쁨"],
    "흥분": ["#흥분", "#열정"],
    "느긋": ["#느긋", "#여유"],
    "안도": ["#안도", "#안심"],
    "신이 난": ["#신남", "#기쁨"],
    "자신하는": ["#자신감", "#자존감"]
}

def predict_6_emotions(text, top_k=3):
    inputs = tokenizer_6(text, return_tensors="pt", padding=True, truncation=True, max_length=512)
    inputs = {k: v.to(device) for k, v in inputs.items()}
    with torch.no_grad():
        logits = model_6(**inputs).logits
    probs = torch.softmax(logits, dim=1).squeeze().cpu().numpy()
    top_idx = probs.argsort()[::-1][:top_k]
    return [(label2emotion_6[idx], float(probs[idx])) for idx in top_idx], probs

def predict_60_emotions(text, top_k=10):
    inputs = tokenizer_60(text, return_tensors="pt", padding=True, truncation=True, max_length=512)
    inputs = {k: v.to(device) for k, v in inputs.items()}
    with torch.no_grad():
        logits = model_60(**inputs).logits
    probs = torch.softmax(logits, dim=1).squeeze().cpu().numpy()
    top_indices = probs.argsort()[::-1][:top_k]
    top_emotions = [(label2emotion_60[idx], float(probs[idx])) for idx in top_indices]
    return top_emotions, probs

def make_tags_prob_and_map(top_emotions, tag_map, threshold=0.05):
    tags = set()
    for emotion, prob in top_emotions:
        if prob >= threshold:
            if emotion in tag_map:
                tags.update(tag_map[emotion])
            else:
                tags.add("#" + emotion)
    return list(tags)

# 메인 실행 함수
def run_analysis():
    text = input("님하이요 ")

    top_6, _ = predict_6_emotions(text)
    top_60, _ = predict_60_emotions(text)

    tags = make_tags_prob_and_map(top_60, emotion_to_tags_map, threshold=0.05)

    top3_emotions = tuple([emo for emo, _ in top_60[:3]])
    matched_tags = None
    for combo in custom_combinations.keys():
        if set(combo) == set(top3_emotions):
            matched_tags = custom_combinations[combo]
            break

    print("\n 예측된 감정 (6개 분류):")
    for emotion, prob in top_6:
        print(f"- {emotion}: {prob:.4f}")

    print("\n 예측된 감정 (60개 분류):")
    for emotion, prob in top_60[:10]:
        print(f"- {emotion}: {prob:.4f}")

    print("\n 일반 태그:")
    print(tags)

    if matched_tags:
        print("\n 커스텀 태그:")
        print(matched_tags)
    else:
        print("\n 커스텀 태그 없음.")

# 프로그램 실행
if __name__ == "__main__":
    run_analysis()