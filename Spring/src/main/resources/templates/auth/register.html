<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>:: 해일 :: 회원가입</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/auth-styles.css}">
</head>
<body>
<div class="container">
    <h2>회원가입</h2>
    <p class="description">Haeil-해일의 회원이 되어 감정을 기록해보세요.</p>

    <form action="/register/newUser" method="POST" id="registerForm" onsubmit="return validateForm()">
        <!--    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">-->
        <!-- 이메일 -->
        <label for="email">이메일</label>
        <input type="email" id="email" name="email" placeholder="이메일 주소" required onkeyup="validateEmail()"
               onblur="validateEmail()">
        <span id="emailError" class="error"></span>

        <!-- 비밀번호 -->
        <label for="password">비밀번호</label>
        <input type="password" id="password" name="password" placeholder="영문, 숫자, 특수문자 포함 8~20자" required minlength="8"
               maxlength="20" pattern="^(?=.*[a-zA-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,20}$"
               onkeyup="validatePassword(); checkPasswordMatch()" onblur="validatePassword()">
        <span id="passwordError" class="error"></span>
        <!-- 최소 8자, 최대 20자.
        적어도 하나의 소문자 (?=.*[a-z]) 적어도 하나의 대문자 (?=.*[A-Z]) 적어도 하나의 숫자 (?=.*\d)
        적어도 하나의 특수문자 (@$!%*?&) (?=.*[@$!%*?&])를 포함해야 합니다. -->

        <!-- 비밀번호 확인 -->
        <label for="passwordConfirm">비밀번호 확인</label>
        <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호 재입력" required
               onkeyup="checkPasswordMatch()">
        <span id="passwordConfirmError" class="error"></span>

        <!-- 이름 -->
        <label for="name">이름</label>
        <input type="text" id="name" name="name" placeholder="이름" required>
        <!--               onkeyup="validateName()" onblur="validateName()"-->
        <span id="nameError" class="error"></span>

        <!-- 핸드폰 번호 -->
        <label for="phone">핸드폰 번호</label>
        <input type="tel" id="phone" name="phone" placeholder="'-' 없이 숫자만 입력" required>
        <span id="phoneError" class="error"></span>

        <!-- 닉네임 -->
        <label for="nickname">닉네임</label>
        <input type="text" id="nickname" name="nickname" placeholder="2~15자" required minlength="2" maxlength="15"
               onkeyup="validateNickname()" onblur="validateNickname()">
        <span id="nicknameError" class="error"></span>

        <!-- 프로필 이미지 URL (선택) -->
        <label for="profileImage">프로필 이미지 URL (선택)</label>
        <input type="url" id="profileImage" name="profileImage" placeholder="https://example.com/image.png">
        <span id="profileImageError" class="error"></span>

        <button type="submit">가입하기</button>
    </form>

    <div class="links">
        <a href="/">이미 계정이 있으신가요? 로그인</a>
    </div>
</div>

<!-- 에러 모달 -->
<div id="errorModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>알림</h3>
        <!-- ul 태그에 스타일을 직접 추가하여 디자인을 개선 -->
        <ul id="errorList" style="list-style-type: none; padding: 0; text-align: left;"></ul>
        <div class="modal-actions">
            <button id="closeErrorBtn">확인</button>
        </div>
    </div>
</div>

<!-- 서버 에러 메시지를 JS로 전달 -->
<script th:inline="javascript">
    /*<![CDATA[*/
        const serverErrors = /*[[${errors}]]*/ null;
        const emailErrorFromServer = /*[[${emailError}]]*/ null;
    /*]]>*/

    window.onload = function () {
        const errorMessages = [];

        if (emailErrorFromServer) {
            errorMessages.push(emailErrorFromServer);
        }

        if (serverErrors && Array.isArray(serverErrors)) {
            serverErrors.forEach(err => {
                if (err?.defaultMessage) errorMessages.push(err.defaultMessage);
            });
        }

        if (errorMessages.length > 0) {
            showModal(errorMessages);
        }

        const closeBtn = document.getElementById('closeErrorBtn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                document.getElementById('errorModal').style.display = 'none';
                document.getElementById('errorList').innerHTML = '';
            });
        }
    };

    function showModal(messages) {
        const modal = document.getElementById('errorModal');
        const list = document.getElementById('errorList');
        list.innerHTML = '';
        messages.forEach(msg => {
            const li = document.createElement('li');
            li.textContent = msg;
            list.appendChild(li);
        });
        modal.style.display = 'flex';
    }
</script>

<!-- 클라이언트 유효성 검사 -->
<script src="/js/registerValidation.js" defer></script>
</body>
</html>
